# QA 컨트롤 패널 사용 가이드

AI Cafe 키오스크의 음성 주문 시스템을 테스트하기 위한 QA 컨트롤 패널 사용법입니다.

## 활성화 방법

### 1. 환경 변수 설정

`.env.local` 파일에 다음 설정 추가:

```bash
NEXT_PUBLIC_QA_PANEL_ENABLED=true
```

### 2. 개발 서버 실행

```bash
npm run dev
```

브라우저에서 `http://localhost:3000` 접속 후 우측 하단의 **🔧 QA Panel** 버튼 클릭

## 패널 구성

### 좌측 컬럼: 제어 및 상태

#### 수동 입력
- 텍스트로 음성 입력 시뮬레이션
- STT 결과를 직접 제공하여 Gemini 처리 테스트
- 실시간 Intent 및 TTS 응답 확인

#### 현재 상태
- **주문 항목**: 현재 주문 목록 개수
- **마지막 Intent**: 최근 처리된 Intent 타입
- **TTS 메시지**: 마지막 음성 안내 메시지

#### 테스트 제어
- **전체 테스트 실행**: 20개 시나리오 자동 순차 실행
- **로그 초기화**: 실행 로그 전체 삭제

#### 테스트 통계
- 총 테스트 수
- 통과/실패 건수
- 성공률 (%)

### 중앙 컬럼: 테스트 시나리오

20개 E2E 테스트 시나리오 목록:

| 번호 | 카테고리 | 시나리오명 |
|------|----------|------------|
| 1-9 | 기본 추가 | 온도 명시/미명시, 단일 온도, 수량, 디저트 등 |
| 10-12 | 수정/삭제 | 메뉴 삭제, 수량 변경, 온도 변경 |
| 13-15 | 복합 명령 | MULTI_ACTION (여러 동작 혼합) |
| 16-17 | 주문 흐름 | 전체 취소, 주문 확정 |
| 18-20 | 예외 처리 | 발음 유사, 부분 매칭, 무관한 발화 |

**사용법**:
- 개별 시나리오 클릭 → 즉시 실행
- 현재 실행 중인 시나리오는 노란색 배경 표시

### 우측 컬럼: 실행 로그

#### 로그 항목 정보
- **타임스탬프**: 실행 시각
- **시나리오명**: `[번호] 시나리오 이름`
- **입력**: 음성 트랜스크립트
- **Intent**: Gemini가 분석한 의도 타입 + confidence
- **검증 결과**:
  - ✓ **PASS** (초록): 모든 검증 통과
  - ✗ **FAIL** (빨강): 검증 실패
  - ⏳ (노랑): 처리 중
- **메시지**: TTS 응답 또는 에러 내용
- **경고**: 치명적이지 않은 문제점

## 자동 검증 규칙

### 검증 항목

| 검증 대상 | 확인 내용 |
|-----------|-----------|
| Intent 타입 | 예상 타입과 일치 여부 |
| 주문 목록 | 메뉴명, 온도, 수량 정확성 |
| TTS 메시지 | 필수 키워드 포함 여부 |

### 예시: 시나리오 #1

**음성 입력**: "따뜻한 아메리카노 주세요"

**검증 규칙**:
1. Intent 타입이 `ADD_ITEM`인가?
2. 주문 목록에 "아메리카노 HOT 1잔"이 있는가?
3. TTS 메시지에 "아메리카노", "추가" 키워드가 포함되었는가?

**통과 조건**: 1, 2번 필수, 3번은 경고

### 예시: 시나리오 #18

**음성 입력**: "아이스 롯데 두 잔이요"

**검증 규칙**:
1. Intent 타입이 `ADD_ITEM`인가?
2. "롯데" → "카페라떼"로 매칭되었는가?
3. 주문 목록에 "카페라떼 ICE 2잔"이 있는가?

## 테스트 시나리오 상세

### 기본 추가 (1-9)

| 번호 | 음성 입력 | 예상 결과 |
|------|-----------|-----------|
| 1 | "따뜻한 아메리카노 주세요" | HOT 아메리카노 1잔 추가 |
| 2 | "아이스 카페라떼 하나요" | ICE 카페라떼 1잔 추가 |
| 3 | "바닐라라떼 주세요" | 온도 선택 모달 표시 |
| 4 | "콜드브루 주세요" | ICE 콜드브루 1잔 자동 추가 |
| 5 | "에스프레소 한 잔이요" | HOT 에스프레소 1잔 자동 추가 |
| 6 | "아이스 아메리카노 세 잔 주세요" | ICE 아메리카노 3잔 추가 |
| 7 | "따뜻한 카페라떼 두 잔하고 아이스 아메리카노 세 잔이요" | HOT 카페라떼 2잔 + ICE 아메리카노 3잔 |
| 8 | "아이스 아메리카노 두 잔이랑 바닐라라떼 세 잔 주세요" | 아메리카노 추가 + 바닐라라떼 온도 질문 |
| 9 | "크루아상 두 개 주세요" | 크루아상 2개 추가 (온도 없음) |

### 수정/삭제 (10-12)

| 번호 | 초기 상태 | 음성 입력 | 예상 결과 |
|------|-----------|-----------|-----------|
| 10 | 아메리카노 2잔 | "아메리카노 빼주세요" | 아메리카노 삭제 |
| 11 | 아메리카노 2잔 | "아메리카노 다섯 잔으로 바꿔주세요" | 수량 5잔으로 변경 |
| 12 | HOT 카페라떼 1잔 | "카페라떼 아이스로 바꿔주세요" | 온도 ICE로 변경 |

### 복합 명령 (13-15)

| 번호 | 초기 상태 | 음성 입력 | 예상 결과 |
|------|-----------|-----------|-----------|
| 13 | 아메 1잔, 라떼 1잔 | "아메리카노 두 잔으로, 카페라떼 세 잔으로 바꿔줘" | 두 메뉴 모두 수량 변경 |
| 14 | 아메리카노 2잔 | "아이스 카페라떼 추가하고 아메리카노 빼줘" | 라떼 추가 + 아메 삭제 |
| 15 | HOT 아메리카노 1잔 | "아메리카노 아이스로 바꾸고 따뜻한 카페라떼 두 잔 추가해줘" | 온도 변경 + 추가 |

### 주문 흐름 (16-17)

| 번호 | 초기 상태 | 음성 입력 | 예상 결과 |
|------|-----------|-----------|-----------|
| 16 | 아메 2잔, 라떼 1잔 | "전부 취소해주세요" | 주문 목록 비움 |
| 17 | 아메 2잔, 라떼 1잔 | "결제할게요" | 주문 확정 |

### 예외 처리 (18-20)

| 번호 | 음성 입력 | 예상 결과 |
|------|-----------|-----------|
| 18 | "아이스 롯데 두 잔이요" | "롯데" → "카페라떼"로 매칭 |
| 19 | "따뜻한 아매 하나요" | "아매" → "아메리카노"로 매칭 |
| 20 | "오늘 날씨 어때요?" | UNKNOWN Intent, 주문 무관 응답 |

## 테스트 실행 워크플로우

### 수동 테스트

1. QA 패널 열기 (우측 하단 버튼)
2. "수동 입력" 섹션에 트랜스크립트 입력
3. "전송" 버튼 클릭
4. 우측 로그에서 결과 확인

### 자동 테스트 (전체)

1. QA 패널 열기
2. "전체 테스트 실행" 버튼 클릭
3. 20개 시나리오 순차 실행 (각 2.5초 + 1초 딜레이)
4. 테스트 통계에서 성공률 확인
5. 실패한 케이스 로그 확인 및 디버깅

### 개별 시나리오 테스트

1. QA 패널 열기
2. 중앙 컬럼에서 원하는 시나리오 클릭
3. 실행 결과 즉시 확인

## 디버깅 팁

### Intent가 UNKNOWN으로 반환되는 경우

**원인**:
- Gemini confidence가 0.4 미만
- 메뉴 매칭 실패
- 주문과 무관한 발화

**해결**:
1. `src/lib/gemini/prompts.ts`에서 발음 유사도 패턴 추가
2. confidence threshold 조정 (`useGeminiOrder.ts`)
3. 폴백 로직 확인 (`matchVoiceToMenu`)

### 수량이 잘못 인식되는 경우

**원인**:
- 한글 수량 파싱 오류
- 복수 메뉴 주문 시 수량 배분 실패

**해결**:
1. 프롬프트의 수량 처리 규칙 강화
2. 예시 추가 (한글 수량 → 숫자)

### 온도 충돌이 발생하지 않는 경우

**원인**:
- 단일 온도 메뉴에 온도 명시 안 함
- Gemini가 기본 온도 자동 선택

**해결**:
1. 프롬프트에 온도 처리 규칙 명확화
2. `ASK_CLARIFICATION` 조건 강화

## 한계 및 알려진 이슈

### 초기 주문 상태 설정 미구현

- 시나리오 10-17은 초기 주문 상태가 필요하나 현재 수동 설정만 가능
- `useOrderStore`에 초기화 함수 추가 필요

### 온도 선택 모달 자동화 불가

- 시나리오 3, 8 등 온도 선택이 필요한 경우 수동 클릭 필요
- 향후 프로그래매틱 온도 선택 API 추가 예정

### 테스트 간 독립성 부족

- 이전 테스트의 주문 상태가 남아있을 수 있음
- 각 시나리오 실행 전 `clearOrder()` 호출 필요

## 향후 개선 사항

1. **초기 주문 상태 자동 설정**: `scenario.initialOrder` 지원
2. **온도 선택 자동화**: API를 통한 프로그래매틱 온도 선택
3. **테스트 격리**: 각 시나리오 실행 전 자동 초기화
4. **테스트 리포트 생성**: JSON/CSV 형식으로 결과 내보내기
5. **회귀 테스트**: CI/CD 파이프라인 통합
6. **검증 규칙 확장**: 나머지 10개 시나리오 검증 로직 추가
7. **시각적 회귀 테스트**: 스크린샷 비교

## 문의

QA 패널 관련 문의는 개발 팀에 문의하세요.
